## Related to RBAC eariler 

```bash 
 sudo kubectl get clusterrolebinding | grep "cluster-admin"
```
```bash
cluster-admin                                            ClusterRole/cluster-admin                                                          4m1s
kubeadm:cluster-admins                                   ClusterRole/cluster-admin                                                          4m1s
```

RBAC 
Who can do WHAT on WHICH resources WHERE?
KUBERNETES BREAKS THIS INTO 4 OBJECTS 
| Object | Purposes| 
|--|--|
|Subject| Who (user,group,service account)|
|Role| What actions (verbs) |
|RoleBindings | Connects who -> what ((namespace))|
|ClusterRole/ClusterRoleBinding| Same, but cluster-wide |

### 1. Subjects: Who is accessing the cluster ? 
Kubernetes supportss 
- Users ( cert-based, external )
- Groups 
- ServiceAccount(pod, controllers )

In our setup, we will use 
- admin user 
- developer user 
- service account 


### 2. ROLES: What can they do ?
Verbs 
```bash 
get, list, watch , create, update, patch , delete 
```

Resources 
```bash
pods, services, deployments, nodes, secrets, configmap
```
### 3. Namespace vs Cluster Scope 
Namespace -> App teams, devs 
Cluster -> Admins , infras 

*** 
## PRACTICING THE RBAC 
1. Working with Cluster Admins (full access )
- ClusterRoleBinding 
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata: 
    name: admin-binding 
subjects: 
- kind: User 
  name: admin-user 
  apiGroup: rbac.authorization.k8s.io 
roleRef: 
  kind: ClusterRole 
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io 
```
`kubectl apply -f admin-binding.yaml `
- full cluster control 
- same power as kubectl with admin.conf 

2. Developer (namespace limited )
- create the namespace 
`kuebctl create namespace dev `

- Role (namespace-scoped )
```yaml 
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata: 
    namespace: dev
    name: dev-role 
rules: 
- apiGroups: ["","apps"]
  resources: ["pods", "services", "deployments"]
  verbs: ["get","list","watch","create","update","delete"]
```
- RoleBinding 
```yaml 
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding 
metadata: 
    namespace: dev 
    name: dev-binding
subjects: 
    - kind: User 
      name: dev-user 
roleRef: 
    kind: Role 
    name: dev-role 
    apiGroup: rbac.authorization.k8s.io 
```
> Dev can deploy apps 
> - cannot touch other namespaces 
> - cannot access nodes / secrets 


3. ServiceAccount(pods)
Create the service account 
```yaml
apiVersion: v1 
kind: ServiceAccount 
metadata: 
    name: app-sa
    namespace: dev 

```
Bind readonly-access
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role 
metadata: 
    namespace: dev
    name: readonly-role 
rules: 
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get","list"]
```
RoleBinding
```yaml 
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata: 
    namespace: dev
    name: sa-binding 
subjects: 
- kind: ServiceAccount 
  name: app-sa 
  namespace: dev 
roleRef: 
  kind: Role 
  name: readonly-role 
  apiGroup: rbac.authorization.k8s.io 

```

5. How kubenretes authenticate USERS (important )
Kubernetes doesn't store users internally 

Users are authenticated via
- client certificates 
- OIDC(Keycloaks , Google, etc )

Example cert-based user 
```bash 
kubectl config set-credentials dev-user \
    --user-certificate=dev.crt \
    --client-key=dev.key 

```
6. How to test RBAC 
```bash 
kubectl auth can-i delete pods --namespace dev --as dev-user 
kubectl auth can-i delete nodes --as dev-user 
```

inside the `roles/rbac/files `
```yaml 
- name: Apply RBAC manifests 
  shell: kubectl apply -f /opt/rbac

```